# Інтеграція подій малювання: документація

Цей документ описує архітектуру та підхід до синхронізації малювання через події з використанням JSON.

## Архітектура системи подій малювання

Нова система використовує стандартизовану модель подій, які передаються між клієнтами через сервер. Ключові компоненти:

1. **Модель події (`DrawingEvent`)** - стандартна структура даних для всіх платформ
2. **Сховище подій** - серверна частина зберігає події в базі даних
3. **API для обробки подій** - REST API та WebSocket для передачі подій
4. **Менеджер подій** - клієнтська частина для роботи з подіями на пристрої

## Формат події малювання (JSON)

```json
{
  "event_id": "fire-2023-09-15-001",
  "event_name": "Пожежа на вул. Шевченка 10",
  "drawing_type": "polygon",
  "action": "add_point",
  "platform": "android",
  "timestamp": "2023-09-15T12:34:56Z",
  "style": {
    "color": "#FF0000",
    "width": 3.0,
    "fill": true,
    "opacity": 0.7
  },
  "data": {
    "lat": 48.12345,
    "lon": 30.67890
  }
}
```

### Поля події

| Поле | Тип | Опис |
| ---- | --- | ---- |
| `event_id` | string | Унікальний ідентифікатор події (складається з типу події, дати та номера) |
| `event_name` | string | Назва події (необов'язкове) |
| `drawing_type` | string | Тип малювання (`polygon`, `line`, `marker`, `text` та ін.) |
| `action` | string | Дія в контексті малювання (`add_point`, `finish`, `delete`, `update` та ін.) |
| `platform` | string | Платформа, з якої надіслана подія (`android`, `windows`) |
| `timestamp` | string | Час створення події в форматі ISO |
| `style` | object | Стильові параметри малювання (колір, товщина, заповнення) |
| `data` | object | Дані малювання (координати, текст та інші специфічні для типу дані) |

## Типи подій малювання

1. **polygon** - полігон (область)
   - Дії: `add_point`, `update_point`, `remove_point`, `finish`
   - Дані: координати точок (`lat`, `lon`)

2. **line** - лінія
   - Дії: `add_point`, `update_point`, `finish`
   - Дані: координати точок (`lat`, `lon`)

3. **marker** - маркер (точка)
   - Дії: `add`, `update`, `remove`
   - Дані: координати (`lat`, `lon`), опційно - `icon`, `label`

4. **text** - текстова мітка
   - Дії: `add`, `update`, `remove`
   - Дані: координати (`lat`, `lon`), `text`, `font_size`

## Синхронізація між платформами

1. **Публікація події**:
   - Клієнт створює подію з унікальним `event_id`
   - Подія надсилається через WebSocket або REST API
   - Сервер зберігає подію та розсилає її іншим клієнтам

2. **Отримання подій**:
   - При підключенні клієнт запитує всі події для кімнати
   - Клієнт застосовує події в хронологічному порядку
   - Нові події надходять через WebSocket

3. **Вирішення конфліктів**:
   - Події мають часову мітку `timestamp`
   - При конфлікті пріоритет має подія з пізнішим часом
   - Події з однаковим `event_id` вважаються дублікатами

## Робота в офлайн режимі

1. **Локальне зберігання**:
   - Клієнт зберігає події в локальному JSON-файлі
   - Кожна кімната має окремий файл подій

2. **Синхронізація після відновлення зв'язку**:
   - Клієнт надсилає всі локальні події на сервер
   - Сервер обробляє події та оновлює стан

## Інтеграція з існуючими компонентами

1. **Клієнтська частина**:
   - `EventManager` - керує подіями на клієнті
   - `DrawingEventSync` - обробляє синхронізацію подій малювання

2. **Серверна частина**:
   - `DrawingEvent` модель - стандартизує формат подій
   - API-ендпоінти для роботи з подіями
   - WebSocket-обробник для передачі подій в реальному часі

## Підтримка існуючих форматів

Для забезпечення зворотної сумісності, система підтримує обидва формати:
- Старий формат команд малювання
- Новий формат подій малювання

Клієнти мають визначити підтримувані формати при підключенні до сервера.

## Приклади використання

### 1. Додавання точки до полігону

```json
{
  "event_id": "fire-2023-09-15-001-point-1",
  "event_name": "Пожежа на вул. Шевченка 10",
  "drawing_type": "polygon",
  "action": "add_point",
  "platform": "android",
  "timestamp": "2023-09-15T12:34:56Z",
  "style": {
    "color": "#FF0000",
    "width": 2.0,
    "fill": true,
    "opacity": 0.5
  },
  "data": {
    "lat": 48.12345,
    "lon": 30.67890
  }
}
```

### 2. Завершення малювання полігону

```json
{
  "event_id": "fire-2023-09-15-001-finish",
  "event_name": "Пожежа на вул. Шевченка 10",
  "drawing_type": "polygon",
  "action": "finish",
  "platform": "android",
  "timestamp": "2023-09-15T12:35:30Z",
  "style": {
    "color": "#FF0000",
    "width": 2.0,
    "fill": true,
    "opacity": 0.5
  },
  "data": {
    "points_count": 5
  }
}
```

### 3. Додавання маркера

```json
{
  "event_id": "hydrant-2023-09-15-001",
  "event_name": "Пожежний гідрант вул. Франка 20",
  "drawing_type": "marker",
  "action": "add",
  "platform": "windows",
  "timestamp": "2023-09-15T12:40:15Z",
  "style": {
    "color": "#0000FF",
    "width": 1.0,
    "fill": false,
    "opacity": 1.0
  },
  "data": {
    "lat": 48.13579,
    "lon": 30.24680,
    "icon": "hydrant",
    "label": "H-123"
  }
}
```

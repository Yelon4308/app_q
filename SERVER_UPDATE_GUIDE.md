# Оновлення сервера для підтримки подій малювання

Цей документ описує процес оновлення серверної частини для підтримки нової системи подій малювання.

## Огляд змін

1. Додано нову модель `DrawingEvent` для стандартизації подій малювання
2. Створено таблицю `drawing_events` в базі даних 
3. Додано новий API-ендпоінт `/api/events` для роботи з подіями
4. Оновлено WebSocket-обробник для підтримки повідомлень типу `drawing_event`

## Кроки для оновлення

1. **Переконайтеся, що ви маєте останні версії файлів:**
   - `models/drawing_event.py` - модель події малювання
   - `api/events.py` - API-ендпоінт для роботи з подіями
   - `database.py` - оновлено для роботи з подіями
   - `main.py` - оновлено для включення API подій
   - `migrate_db.py` - скрипт міграції бази даних

2. **Виконайте міграцію бази даних:**
   ```bash
   python migrate_db.py
   ```
   Це створить нову таблицю `drawing_events` і збереже всі існуючі дані.

3. **Перезапустіть сервер:**
   ```bash
   python main.py
   ```
   або
   ```bash
   uvicorn main:app --reload --host 0.0.0.0 --port 8000
   ```

## API для роботи з подіями

### Створення події

```
POST /api/events/{room_id}
```

**Тіло запиту:**
```json
{
  "event_id": "fire-2023-09-09-001",
  "event_name": "Пожежа на вул. Шевченка 10",
  "drawing_type": "polygon",
  "action": "add_point",
  "platform": "android",
  "style": {
    "color": "#FF0000",
    "width": 3,
    "fill": true,
    "opacity": 0.5
  },
  "data": {
    "lat": 48.12345,
    "lon": 30.67890
  }
}
```

### Отримання подій для кімнати

```
GET /api/events/{room_id}
```

### Отримання конкретної події

```
GET /api/events/{room_id}/{event_id}
```

### Видалення події

```
DELETE /api/events/{room_id}/{event_id}
```

### Видалення всіх подій у кімнаті

```
DELETE /api/events/{room_id}
```

## WebSocket повідомлення

Клієнти можуть надсилати та отримувати події через WebSocket:

**Надсилання події:**
```json
{
  "type": "drawing_event",
  "event_id": "fire-2023-09-09-001",
  "drawing_type": "polygon",
  "action": "add_point",
  "platform": "android",
  "data": {
    "lat": 48.12345,
    "lon": 30.67890
  },
  "style": {
    "color": "#FF0000",
    "width": 2.0,
    "fill": true,
    "opacity": 0.7
  }
}
```

## Поради щодо інтеграції з клієнтами

1. Використовуйте унікальні `event_id` для подій, наприклад поєднання типу, дати та порядкового номеру
2. Підтримуйте кешування подій на клієнті для оптимізації роботи в автономному режимі
3. При підключенні до кімнати запитуйте всі існуючі події через API `/api/events/{room_id}`
4. Для синхронізації подій у реальному часі використовуйте WebSocket повідомлення типу `drawing_event`
